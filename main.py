#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠶⠶⠶⠶⠶⠶⠶⠶⣶⣶⣶⣶⣶⠶⠶⠶⠶⠶⠶⠶⢶⣤⣤⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⣠⡿⠋⠀⠀⠀⠀⢀⡠⠔⠒⢉⣉⣀⣠⠠⢄⣠⣀⣀⡀⠀⠀⠀⠀⠀⠀⠉⣉⣛⣛⡛⠷⣦⣄⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⢀⣼⠏⠀⠀⠀⢀⠴⠊⣡⠔⣚⡩⠥⠤⠤⠔⠦⢤⠄⠀⠀⠈⠉⠉⠉⠉⣉⣉⣉⣀⣀⠀⠉⠀⠈⠙⠻⣦⡀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠊⢁⡴⢋⠴⠊⠁⠀⠀⠀⠀⠀⠀⠀⢣⠀⠀⠀⠀⠀⠈⢹⠃⠀⠀⠀⠀⠉⠢⡀⠀⠀⠀⠸⣷⠀⠀⠀⠀
#         ⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠀⠀⠉⠐⠁⣀⣤⣴⣶⣶⣶⡶⣶⣤⣀⠈⠀⠀⠀⠀⠀⠀⡎⠀⠀⢀⣀⣀⠀⠀⠑⠀⠀⠀⠀⢿⡄⠀⠀⠀
#         ⠀⠀⢀⣴⣿⣷⡤⠄⠀⠀⠀⣤⡔⠀⣾⣿⣽⣿⣿⣿⣿⣤⣄⡉⠻⣷⡆⠀⠀⠀⣀⣀⣤⣶⣿⣿⣿⣿⣿⣷⠄⠤⠤⠤⢤⣈⠻⣶⡀⠀
#         ⠀⣴⢟⡟⠁⢀⣴⡶⠾⠶⣶⣤⣈⡁⠈⠉⠀⣀⣴⡗⠀⠉⠙⠻⢿⠟⠁⠀⠀⠀⠙⢻⣿⠛⠋⠉⠉⠀⠀⠀⠀⢀⣀⣀⠰⢌⠓⢌⢿⡄
#         ⣸⡏⢸⠀⣰⡿⠁⠀⢠⣷⡀⠉⠙⠛⠻⠿⠟⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⡀⠀⠀⠀⢶⣤⣤⣾⠟⠛⠛⠿⠆⡇⢘⣾⡇
#         ⣿⡄⢸⠀⣿⡇⣠⣴⣿⡟⠻⢷⣦⣄⡀⠀⠀⠀⣀⣀⣀⡤⢦⣴⡶⠶⠀⠀⠀⠀⠀⠀⠉⠻⣷⣄⠀⠀⠉⠉⠁⢠⣿⡀⠀⢀⠇⢸⣻⡇
#         ⢹⣧⠘⡆⠸⣧⠀⠀⢹⣷⣄⠀⠈⠙⣿⡷⣶⣤⣄⣀⠀⠀⠘⣷⡄⢶⠷⠶⠦⠀⠀⠀⢀⣴⡿⠿⠛⠢⢄⠀⢀⣼⣿⣧⢀⡡⠔⣻⡟⠀
#         ⠀⠹⣷⣌⠓⠬⠀⠀⠈⠻⣿⣷⣦⣄⣿⣧⠀⠈⠉⠛⠻⢷⣶⣮⣥⣄⣀⡀⠀⠀⠹⠷⠟⠋⠀⠀⢀⣀⣤⣷⣿⠿⣿⣿⠀⠀⢰⡿⠁⠀
#         ⠀⠀⠈⠻⣯⡀⠀⠀⠀⠀⠙⣷⡌⠙⣿⣿⣿⣶⣤⣄⡀⣼⡏⠀⠉⠉⠛⢻⣿⠟⠿⠿⣿⡿⠿⠟⠛⣿⡏⠀⣿⡇⣿⣿⠀⠀⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠙⣷⡀⠀⠀⠀⠀⠈⢻⣦⣾⠇⠈⠙⠛⠿⣿⣿⣷⣶⣤⣤⣤⣤⣿⣤⣤⣤⣼⣧⣤⣤⣤⣼⣷⣴⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠘⣷⡄⠀⠀⠀⠀⠀⠙⠻⣦⣄⠀⠀⠀⣸⡏⠉⠙⠛⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠈⢿⣦⡀⠀⡀⠀⠀⠀⠈⠛⢷⣦⣠⣿⠁⠀⠀⠀⠀⢈⣿⠀⠉⠉⢉⣿⠛⠛⢻⡿⠋⣹⡟⢹⣿⣾⠇⠀⠀ ⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠘⠻⣦⣉⠓⠤⣉⠒⠤⣀⠈⠙⠻⠷⢶⣤⣤⣄⣸⣿⣀⣀⣀⣸⣟⣀⣠⣿⣇⣴⣿⣶⡾⠟⠁⠀⠀⠀ ⢼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠿⣦⣌⡉⠲⠤⣉⠒⠦⢄⣀⠀⠈⠉⠉⠉⠉⠉⠉⠋⠉⠉⠉⠉⠉⠉⠀⠀⠀⡠⠀⠀⡀⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠻⠷⣦⣄⡉⠑⠒⠬⠭⣖⣒⡤⠤⠤⠤⠤⠤⠤⠤⣀⢄⡠⠤⠤⠒⠉⠀⢀⡰⠃⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠷⣶⣤⣀⠀⠀⠈⠉⠉⠒⠒⠒⠒⠐⠠⠦⠴⠤⠴⠤⠴⠒⠉⠀⠀⠀  ⣼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠿⣶⣦⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⣠⣾⠏⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠛⠻⠷⠶⢶⣦⣤⣤⣤⣤⣤⡴⠶⠟⠋⠁⠀⠀⠀⠀
import os
import random

from config import *


# TODO: В функции create_meme (mem_generator.py) появилось много параметров.
#  Все эти параметры полностью защищены (Можешь отсылать любые значения, если они не подойдут она их выправит)
#  ОБРАТИ ВНИМАНИЕ, ЧТО ПОРЯДОК ПЕРЕМЕННЫХ ПОМЕНЯЛСЯ!!!
# Старые параметры, которые ты знаешь:
#  path_img
#  bottom_text
#  upper_text
#  search_text
#  mode
# Новые параметры
#  upper_color строка цвет
#  bottom_color строка цвет
#  upper_stroke_color строка цвет
#  bottom_stroke_color строка цвет
#  stroke_width целое число
#  giant_text булевое значение
#  В цветовые параметры можно отсылать буковки (F, P, R, M, Y, O, L, G, A, T, B, N, W)
#  или хеш код (#c1121f) хеш обязателен, по нему она определяет, что это не буковка
# TODO:
#  В общем удачи, я тебе дал функцию, ебись с ней как хочешь (Не забудь скачать assets из тг)
#
#  Послесловие я к тебе в функции не лез и ты не лезь пж


class explain_blyat(BaseFilter):
    async def __call__(self, message: Message) -> bool:
        required = 'поясни за '
        return message.text[0:len(required)].lower() == required


# class MemeStates(StatesGroup):
#     demotivator = State()
#     meme = State()
#     book = State()


meme_button: KeyboardButton = KeyboardButton(
    text='Мемас')
demotivator_button: KeyboardButton = KeyboardButton(
    text='Демотиватор')
book_button: KeyboardButton = KeyboardButton(
    text='Чтиво')
settings_button: KeyboardButton = KeyboardButton(
    text='Настройки')
basic_keyboard: ReplyKeyboardMarkup = ReplyKeyboardMarkup(
    keyboard=[[meme_button, demotivator_button], [book_button, settings_button]], resize_keyboard=True)


@dp.message(F.text, explain_blyat())
async def explain_func(message: Message):
    required = 'поясни за '
    txt = message.text[len(required):]

    sent_message = await message.answer('Секунду, братан, шестерёнки работают')
    loading_task = asyncio.create_task(loading_indicator(sent_message.chat.id, sent_message.message_id))
    try:
        response = await get_neuro_comment(txt.replace("\n", " "))
        await message.answer(response, reply_markup=basic_keyboard)
    finally:
        loading_task.cancel()
        await bot.delete_message(chat_id=message.chat.id, message_id=sent_message.message_id)


@dp.message(Command(commands='delete_pictures'), F.from_user.id.in_({972753303}))
async def delete_pictures_in_directory(message: Message):
    try:
        directory = f'{os.path.dirname(__file__)}/pictures'
        files = os.listdir(directory)
        for file in files:
            file_path = os.path.join(directory, file)
            os.remove(file_path)
        await message.answer('Файлы удалены! ✅')
    except Exception as e:
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 634\n{e}')


@dp.message(CommandStart())
async def process_start_command(message: Message):
    await UserDB.add_new_user(message.from_user.id, message.from_user.username)
    await message.answer('Привет! В этом боте ты можешь сгенерировать мем или демотиватор!', reply_markup=basic_keyboard)


@dp.message(Command(commands='meme'))
async def send_meme_lmao(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='in')


@dp.message(Command(commands='help'))
async def help_command(message: Message):
    await message.answer('<b>Помощь калекам</b>\nДля создания реальной ржаки, тебе нужно нажать на кнопочки снизу (Выбрать шаблон)\n'
                         'Далее пишешь: запрос на картинку, текст сверху и текст снизу. Всё с новой строчки!\n\n'
                         '<b>Пример</b>\n'
                         '<blockquote>Камчатка\n'
                         'Сочи\n'
                         'Вы ебанутые?</blockquote>\n\n'
                         'Так же ты можешь прислать фотку и подписать её верхним и нижним текстом\n\n'
                         '<b>Пример</b> (Подпись к фотке)\n'
                         '<blockquote>Сочи\n'
                         'Вы ебанутые?</blockquote>', reply_markup=basic_keyboard)


@dp.message(Command(commands='deme'))
async def create_demo_command(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='de')


@dp.message(Command(commands='book'))
async def create_demo_command(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='bo')


@dp.message(F.text == 'Настройки')
async def settings_handler(message: Message, edit=False):
    user = await UserDB.get_user(message.from_user.id, message.from_user.username)

    txt = ('<b>Твои текущие настройки</b>\n\n'
           f'Режим: <i><b>{modes_name[user.mode][0]}</b></i>\n'
           f'Цвет верхнего текста: <i><u>{get_colorname_by_hashcode(user.upper_color)}</u></i>\n'
           f'Цвет нижнего текста: <i><u>{get_colorname_by_hashcode(user.bottom_color)}</u></i>\n'
           f'Контур верхнего текста: <i><u>{get_colorname_by_hashcode(user.upper_stroke_color)}</u></i>\n'
           f'Контур нижнего текста: <i><u>{get_colorname_by_hashcode(user.bottom_stroke_color)}</u></i>\n'
           f'Регистр текста: <i>{"<b>БАЛЬШИЕ БУКАВЫ</b>" if user.giant_text else "маленькие буковки"}</i>\n')
    if edit:
        await message.edit_text(txt, reply_markup=get_keyboard(user))
    else:
        await message.answer(txt, reply_markup=get_keyboard(user))


@dp.message(F.text == 'Демотиватор')
async def set_demotivator(message: Message):
    await UserDB.change_mode(message.from_user.id, 'de')
    await message.answer('Режим изменён на <b>демотиватор</b>', reply_markup=basic_keyboard)


@dp.message(F.text == 'Мемас')
async def set_meme(message: Message):
    await UserDB.change_mode(message.from_user.id, 'in')
    await message.answer('Режим изменён на <b>мемас</b>', reply_markup=basic_keyboard)


@dp.message(F.text == 'Чтиво')
async def set_book(message: Message, ):
    await UserDB.change_mode(message.from_user.id, 'bo')
    await message.answer('Режим изменён на <b>чтиво</b>', reply_markup=basic_keyboard)


async def send_meme(message: Message, user: UserDB, mode=None):
    try:
        if message.text is None and message.caption is None:
            await message.answer('Ты забыл про надпись')
            return
        meme_txt = (message.text if message.text else message.caption).strip().split('\n')
        meme_txt[0] = meme_txt[0].replace('/', '').replace("\\", '')
        photo_path = None
        if message.photo:
            photo_path = f'{os.path.dirname(__file__)}/pictures/photo{random.randint(1, 10 ** 8)}.jpg'
            await bot.download_file((await bot.get_file(message.photo[-1].file_id)).file_path, photo_path)

        try:
            meme_path = await create_meme(photo_path, *meme_txt,
                                          mode=mode if mode else user.mode,
                                          upper_color=user.upper_color,
                                          bottom_color=user.bottom_color,
                                          upper_stroke_color=user.upper_stroke_color,
                                          bottom_stroke_color=user.bottom_stroke_color,
                                          stroke_width=user.stroke_width,
                                          giant_text=user.giant_text)
            await message.answer_photo(photo=FSInputFile(meme_path), reply_markup=basic_keyboard)
            os.remove(meme_path)
        except Exception as e:
            await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
            await bot.send_message(chat_id=972753303, text=f'Произошла ошибка!\n{e}')
    except Exception as e:
        await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 234\n{e}')


@dp.callback_query(SetsCallBack.filter())
async def settings_button_distributor(callback: CallbackQuery, callback_data: SetsCallBack):
    action = callback_data.action
    user = await UserDB.get_user(callback.from_user.id, callback.from_user.username)

    async def user_mode(user):
        current_mode_name = f"У вас включен режим: <b>{modes_name[user.mode][0]}</b>"
        await callback.message.edit_text(current_mode_name, reply_markup=get_mode_keyboard(user.mode))

    async def color_mode(user, action):
        txt = ''
        mode_offset = 1
        current_color = '#000000'
        if action == UPPERTEXT_ACTION:
            txt = 'верхнего текста'
            mode_offset = 1
            current_color = user.upper_color
        elif action == BOTTOMTEXT_ACTION:
            txt = 'нижнего текста'
            mode_offset = 10
            current_color = user.bottom_color
        elif action == UPPERSTROKE_ACTION:
            txt = 'контура верхнего текста'
            mode_offset = 100
            current_color = user.upper_stroke_color
        elif action == BOTTOMSTROKE_ACTION:
            txt = 'контура нижнего текста'
            mode_offset = 1000
            current_color = user.bottom_stroke_color
        await callback.message.edit_text(f'Выберите цвет <i>{txt}</i> или введите его с клавиатуры',
                                         reply_markup=get_color_keyboard(current_color, mode_offset))

    async def text_case_mode(user):
        await callback.message.edit_text(f'Сейчас стоят {"<b>БАЛЬШИЕ БУКАВЫ</b>" if user.giant_text else "<i>маленькие буковки</i>"}',
                                         reply_markup=get_case_keyboard(user.giant_text))

    if user is None:
        await callback.message.answer('Произошла ошибка!')

    if action == USERMODE_ACTION:
        await user_mode(user)

    if action in MODE_CODES_set:
        await UserDB.change_mode(callback.from_user.id, get_mode_name_by_code(action))
        user = await UserDB.get_user(callback.from_user.id, callback.from_user.username)
        await user_mode(user)

    if action == SETTINGS_ACTION:
        await settings_handler(callback.message, True)

    if action in (UPPERTEXT_ACTION, BOTTOMTEXT_ACTION, UPPERSTROKE_ACTION, BOTTOMSTROKE_ACTION):
        await color_mode(user, action)

    if action in COLOR_CODES_set:
        color_places = ('upper_color', 'bottom_color', 'upper_stroke_color', 'bottom_stroke_color')
        offsets = {1000: 3, 100: 2, 10: 1}

        for div, idx in offsets.items():
            if action % div == 0:
                color_place = color_places[idx]
                offset = div
                break
        else:
            color_place = color_places[0]
            offset = 1

        await UserDB.change_color(callback.from_user.id, get_colorhash_by_code(action // offset), color_place)
        user = await UserDB.get_user(callback.from_user.id, callback.from_user.username)
        await user_mode(user)
    if action == TEXTCASE_ACTION:
        await text_case_mode(user)
    if action in (SETgiantcase, SETsmallcase):
        await UserDB.change_text_case(callback.from_user.id, True if action == SETgiantcase else False)
        user = await UserDB.get_user(callback.from_user.id, callback.from_user.username)
        await text_case_mode(user)


@dp.message(F.content_type.in_({'text', 'photo'}))
async def general_send_meme(message: Message):
    user = await UserDB.get_user(message.from_user.id, message.from_user.username)
    await send_meme(message, user)


@dp.message()
async def any_message(message: Message):
    await message.answer(text=random.choice(hz_answers), reply_markup=basic_keyboard)


async def main():
    await dp.start_polling(bot)


if __name__ == '__main__':
    print('Режим клоуна включён!')
    asyncio.run(main())
