#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠶⠶⠶⠶⠶⠶⠶⠶⣶⣶⣶⣶⣶⠶⠶⠶⠶⠶⠶⠶⢶⣤⣤⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⣠⡿⠋⠀⠀⠀⠀⢀⡠⠔⠒⢉⣉⣀⣠⠠⢄⣠⣀⣀⡀⠀⠀⠀⠀⠀⠀⠉⣉⣛⣛⡛⠷⣦⣄⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⢀⣼⠏⠀⠀⠀⢀⠴⠊⣡⠔⣚⡩⠥⠤⠤⠔⠦⢤⠄⠀⠀⠈⠉⠉⠉⠉⣉⣉⣉⣀⣀⠀⠉⠀⠈⠙⠻⣦⡀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠊⢁⡴⢋⠴⠊⠁⠀⠀⠀⠀⠀⠀⠀⢣⠀⠀⠀⠀⠀⠈⢹⠃⠀⠀⠀⠀⠉⠢⡀⠀⠀⠀⠸⣷⠀⠀⠀⠀
#         ⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠀⠀⠉⠐⠁⣀⣤⣴⣶⣶⣶⡶⣶⣤⣀⠈⠀⠀⠀⠀⠀⠀⡎⠀⠀⢀⣀⣀⠀⠀⠑⠀⠀⠀⠀⢿⡄⠀⠀⠀
#         ⠀⠀⢀⣴⣿⣷⡤⠄⠀⠀⠀⣤⡔⠀⣾⣿⣽⣿⣿⣿⣿⣤⣄⡉⠻⣷⡆⠀⠀⠀⣀⣀⣤⣶⣿⣿⣿⣿⣿⣷⠄⠤⠤⠤⢤⣈⠻⣶⡀⠀
#         ⠀⣴⢟⡟⠁⢀⣴⡶⠾⠶⣶⣤⣈⡁⠈⠉⠀⣀⣴⡗⠀⠉⠙⠻⢿⠟⠁⠀⠀⠀⠙⢻⣿⠛⠋⠉⠉⠀⠀⠀⠀⢀⣀⣀⠰⢌⠓⢌⢿⡄
#         ⣸⡏⢸⠀⣰⡿⠁⠀⢠⣷⡀⠉⠙⠛⠻⠿⠟⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⡀⠀⠀⠀⢶⣤⣤⣾⠟⠛⠛⠿⠆⡇⢘⣾⡇
#         ⣿⡄⢸⠀⣿⡇⣠⣴⣿⡟⠻⢷⣦⣄⡀⠀⠀⠀⣀⣀⣀⡤⢦⣴⡶⠶⠀⠀⠀⠀⠀⠀⠉⠻⣷⣄⠀⠀⠉⠉⠁⢠⣿⡀⠀⢀⠇⢸⣻⡇
#         ⢹⣧⠘⡆⠸⣧⠀⠀⢹⣷⣄⠀⠈⠙⣿⡷⣶⣤⣄⣀⠀⠀⠘⣷⡄⢶⠷⠶⠦⠀⠀⠀⢀⣴⡿⠿⠛⠢⢄⠀⢀⣼⣿⣧⢀⡡⠔⣻⡟⠀
#         ⠀⠹⣷⣌⠓⠬⠀⠀⠈⠻⣿⣷⣦⣄⣿⣧⠀⠈⠉⠛⠻⢷⣶⣮⣥⣄⣀⡀⠀⠀⠹⠷⠟⠋⠀⠀⢀⣀⣤⣷⣿⠿⣿⣿⠀⠀⢰⡿⠁⠀
#         ⠀⠀⠈⠻⣯⡀⠀⠀⠀⠀⠙⣷⡌⠙⣿⣿⣿⣶⣤⣄⡀⣼⡏⠀⠉⠉⠛⢻⣿⠟⠿⠿⣿⡿⠿⠟⠛⣿⡏⠀⣿⡇⣿⣿⠀⠀⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠙⣷⡀⠀⠀⠀⠀⠈⢻⣦⣾⠇⠈⠙⠛⠿⣿⣿⣷⣶⣤⣤⣤⣤⣿⣤⣤⣤⣼⣧⣤⣤⣤⣼⣷⣴⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠘⣷⡄⠀⠀⠀⠀⠀⠙⠻⣦⣄⠀⠀⠀⣸⡏⠉⠙⠛⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠈⢿⣦⡀⠀⡀⠀⠀⠀⠈⠛⢷⣦⣠⣿⠁⠀⠀⠀⠀⢈⣿⠀⠉⠉⢉⣿⠛⠛⢻⡿⠋⣹⡟⢹⣿⣾⠇⠀⠀ ⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠘⠻⣦⣉⠓⠤⣉⠒⠤⣀⠈⠙⠻⠷⢶⣤⣤⣄⣸⣿⣀⣀⣀⣸⣟⣀⣠⣿⣇⣴⣿⣶⡾⠟⠁⠀⠀⠀ ⢼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠿⣦⣌⡉⠲⠤⣉⠒⠦⢄⣀⠀⠈⠉⠉⠉⠉⠉⠉⠋⠉⠉⠉⠉⠉⠉⠀⠀⠀⡠⠀⠀⡀⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠻⠷⣦⣄⡉⠑⠒⠬⠭⣖⣒⡤⠤⠤⠤⠤⠤⠤⠤⣀⢄⡠⠤⠤⠒⠉⠀⢀⡰⠃⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠷⣶⣤⣀⠀⠀⠈⠉⠉⠒⠒⠒⠒⠐⠠⠦⠴⠤⠴⠤⠴⠒⠉⠀⠀⠀  ⣼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠿⣶⣦⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⣠⣾⠏⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠛⠻⠷⠶⢶⣦⣤⣤⣤⣤⣤⡴⠶⠟⠋⠁⠀⠀⠀⠀
import os
import random

from config import *


class MemeStates(StatesGroup):
    demotivator = State()
    meme = State()


meme_button: KeyboardButton = KeyboardButton(
    text='Мемас')
demotivator_button: KeyboardButton = KeyboardButton(
    text='Демотиватор')
basic_keyboard: ReplyKeyboardMarkup = ReplyKeyboardMarkup(
    keyboard=[[meme_button, demotivator_button]], resize_keyboard=True)


@dp.message(Command(commands='delete_pictures'), F.from_user.id.in_({972753303}))
async def delete_pictures_in_directory(message: Message):
    try:
        directory = f'{os.path.dirname(__file__)}/pictures'
        files = os.listdir(directory)
        for file in files:
            file_path = os.path.join(directory, file)
            os.remove(file_path)
        await message.answer('Файлы удалены! ✅')
    except Exception as e:
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 634\n{e}')


@dp.message(CommandStart())
async def process_start_command(message: Message, state: FSMContext):
    await message.answer('Привет! В этом боте ты можешь сгенерировать мем или демотиватор!', reply_markup=basic_keyboard)


@dp.message(Command(commands='meme'))
async def create_meme_lmao(message: Message, mode='in'):
    try:
        meme_txt = message.text[5:].strip().split('\n')
        meme_txt[0] = meme_txt[0].replace('/', '').replace("\\", '')
        meme_path = await create_meme(None, *meme_txt, mode=mode)
        await message.answer_photo(photo=FSInputFile(meme_path), reply_markup=basic_keyboard)
        os.remove(meme_path)
    except Exception as e:
        await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 634\n{e}')


@dp.message(Command(commands='help'))
async def help_command(message: Message):
    await message.answer('<b>Помощь калекам</b>\nДля создания реальной ржаки, тебе нужно нажать на кнопочки снизу (Выбрать шаблон)\n'
                         'Далее пишешь: запрос на картинку, текст сверху и текст снизу. Всё с новой строчки!\n\n'
                         '<b>Пример</b>\n'
                         '<blockquote>Камчатка\n'
                         'Сочи\n'
                         'Вы ебанутые?</blockquote>\n\n'
                         'Так же ты можешь прислать фотку и подписать её верхним и нижним текстом\n\n'
                         '<b>Пример</b> (Подпись к фотке)\n'
                         '<blockquote>Сочи\n'
                         'Вы ебанутые?</blockquote>', reply_markup=basic_keyboard)


@dp.message(Command(commands='deme'))
async def create_demo_command(message: Message):
    await create_meme_lmao(message, 'de')


@dp.message(F.text == 'Демотиватор')
async def get_demotivator(message: Message, state: FSMContext):
    await message.answer('Введи текст для шутейки', reply_markup=ReplyKeyboardRemove())
    await state.set_state(MemeStates.demotivator)


@dp.message(F.text == 'Мемас')
async def get_meme(message: Message, state: FSMContext):
    await message.answer('Введи текст для шутейки', reply_markup=ReplyKeyboardRemove())
    await state.set_state(MemeStates.meme)


@dp.message(F.content_type.in_({'text', 'photo'}), StateFilter(MemeStates.demotivator))
async def send_meme(message: Message, state: FSMContext, mode='de'):
    try:
        if message.text is None and message.caption is None:
            await message.answer('Ты забыл про надпись')
            return
        meme_txt = (message.text if message.text else message.caption).strip().split('\n')
        meme_txt[0] = meme_txt[0].replace('/', '').replace("\\", '')
        photo_path = None
        if message.photo:
            photo_path = f'{os.path.dirname(__file__)}/pictures/photo{random.randint(1, 10 ** 8)}.jpg'
            await bot.download_file((await bot.get_file(message.photo[-1].file_id)).file_path, photo_path)
            meme_txt = [None] + meme_txt
        try:
            meme_path = await create_meme(photo_path, *meme_txt, mode=mode)
            await message.answer_photo(photo=FSInputFile(meme_path), reply_markup=basic_keyboard)
            os.remove(meme_path)
        except Exception as e:
            await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
            await bot.send_message(chat_id=972753303, text=f'Произошла ошибка!\n{e}')

        await state.clear()
    except Exception as e:
        await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 234\n{e}')


@dp.message(F.content_type.in_({'text', 'photo'}), StateFilter(MemeStates.meme))
async def send_meme_in_bot(message: Message, state: FSMContext):
    await send_meme(message, state, 'in')


@dp.message(StateFilter(MemeStates.demotivator))
async def warning_demotivator(message: Message, state: FSMContext):
    await message.answer('Это не похоже на текст к мему')


@dp.message()
async def any_message(message: Message, state: FSMContext):
    await message.answer(text=random.choice(hz_answers), reply_markup=basic_keyboard)


async def main():
    await dp.start_polling(bot)


if __name__ == '__main__':
    print('Режим клоуна включён!')
    asyncio.run(main())
