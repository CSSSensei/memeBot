#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠶⠶⠶⠶⠶⠶⠶⠶⣶⣶⣶⣶⣶⠶⠶⠶⠶⠶⠶⠶⢶⣤⣤⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⣠⡿⠋⠀⠀⠀⠀⢀⡠⠔⠒⢉⣉⣀⣠⠠⢄⣠⣀⣀⡀⠀⠀⠀⠀⠀⠀⠉⣉⣛⣛⡛⠷⣦⣄⠀⠀⠀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⢀⣼⠏⠀⠀⠀⢀⠴⠊⣡⠔⣚⡩⠥⠤⠤⠔⠦⢤⠄⠀⠀⠈⠉⠉⠉⠉⣉⣉⣉⣀⣀⠀⠉⠀⠈⠙⠻⣦⡀⠀⠀⠀⠀
#         ⠀⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠊⢁⡴⢋⠴⠊⠁⠀⠀⠀⠀⠀⠀⠀⢣⠀⠀⠀⠀⠀⠈⢹⠃⠀⠀⠀⠀⠉⠢⡀⠀⠀⠀⠸⣷⠀⠀⠀⠀
#         ⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠀⠀⠉⠐⠁⣀⣤⣴⣶⣶⣶⡶⣶⣤⣀⠈⠀⠀⠀⠀⠀⠀⡎⠀⠀⢀⣀⣀⠀⠀⠑⠀⠀⠀⠀⢿⡄⠀⠀⠀
#         ⠀⠀⢀⣴⣿⣷⡤⠄⠀⠀⠀⣤⡔⠀⣾⣿⣽⣿⣿⣿⣿⣤⣄⡉⠻⣷⡆⠀⠀⠀⣀⣀⣤⣶⣿⣿⣿⣿⣿⣷⠄⠤⠤⠤⢤⣈⠻⣶⡀⠀
#         ⠀⣴⢟⡟⠁⢀⣴⡶⠾⠶⣶⣤⣈⡁⠈⠉⠀⣀⣴⡗⠀⠉⠙⠻⢿⠟⠁⠀⠀⠀⠙⢻⣿⠛⠋⠉⠉⠀⠀⠀⠀⢀⣀⣀⠰⢌⠓⢌⢿⡄
#         ⣸⡏⢸⠀⣰⡿⠁⠀⢠⣷⡀⠉⠙⠛⠻⠿⠟⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⡀⠀⠀⠀⢶⣤⣤⣾⠟⠛⠛⠿⠆⡇⢘⣾⡇
#         ⣿⡄⢸⠀⣿⡇⣠⣴⣿⡟⠻⢷⣦⣄⡀⠀⠀⠀⣀⣀⣀⡤⢦⣴⡶⠶⠀⠀⠀⠀⠀⠀⠉⠻⣷⣄⠀⠀⠉⠉⠁⢠⣿⡀⠀⢀⠇⢸⣻⡇
#         ⢹⣧⠘⡆⠸⣧⠀⠀⢹⣷⣄⠀⠈⠙⣿⡷⣶⣤⣄⣀⠀⠀⠘⣷⡄⢶⠷⠶⠦⠀⠀⠀⢀⣴⡿⠿⠛⠢⢄⠀⢀⣼⣿⣧⢀⡡⠔⣻⡟⠀
#         ⠀⠹⣷⣌⠓⠬⠀⠀⠈⠻⣿⣷⣦⣄⣿⣧⠀⠈⠉⠛⠻⢷⣶⣮⣥⣄⣀⡀⠀⠀⠹⠷⠟⠋⠀⠀⢀⣀⣤⣷⣿⠿⣿⣿⠀⠀⢰⡿⠁⠀
#         ⠀⠀⠈⠻⣯⡀⠀⠀⠀⠀⠙⣷⡌⠙⣿⣿⣿⣶⣤⣄⡀⣼⡏⠀⠉⠉⠛⢻⣿⠟⠿⠿⣿⡿⠿⠟⠛⣿⡏⠀⣿⡇⣿⣿⠀⠀⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠙⣷⡀⠀⠀⠀⠀⠈⢻⣦⣾⠇⠈⠙⠛⠿⣿⣿⣷⣶⣤⣤⣤⣤⣿⣤⣤⣤⣼⣧⣤⣤⣤⣼⣷⣴⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠘⣷⡄⠀⠀⠀⠀⠀⠙⠻⣦⣄⠀⠀⠀⣸⡏⠉⠙⠛⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢾⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠈⢿⣦⡀⠀⡀⠀⠀⠀⠈⠛⢷⣦⣠⣿⠁⠀⠀⠀⠀⢈⣿⠀⠉⠉⢉⣿⠛⠛⢻⡿⠋⣹⡟⢹⣿⣾⠇⠀⠀ ⣺⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠘⠻⣦⣉⠓⠤⣉⠒⠤⣀⠈⠙⠻⠷⢶⣤⣤⣄⣸⣿⣀⣀⣀⣸⣟⣀⣠⣿⣇⣴⣿⣶⡾⠟⠁⠀⠀⠀ ⢼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠿⣦⣌⡉⠲⠤⣉⠒⠦⢄⣀⠀⠈⠉⠉⠉⠉⠉⠉⠋⠉⠉⠉⠉⠉⠉⠀⠀⠀⡠⠀⠀⡀⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠻⠷⣦⣄⡉⠑⠒⠬⠭⣖⣒⡤⠤⠤⠤⠤⠤⠤⠤⣀⢄⡠⠤⠤⠒⠉⠀⢀⡰⠃⠀  ⢸⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠷⣶⣤⣀⠀⠀⠈⠉⠉⠒⠒⠒⠒⠐⠠⠦⠴⠤⠴⠤⠴⠒⠉⠀⠀⠀  ⣼⡇⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠿⣶⣦⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⣠⣾⠏⠀⠀⠀
#         ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠛⠻⠷⠶⢶⣦⣤⣤⣤⣤⣤⡴⠶⠟⠋⠁⠀⠀⠀⠀
import os
import random

from config import *


# TODO: В функции create_meme (mem_generator.py) появилось много параметров.
#  Все эти параметры полностью защищены (Можешь отсылать любые значения, если они не подойдут она их выправит)
#  ОБРАТИ ВНИМАНИЕ, ЧТО ПОРЯДОК ПЕРЕМЕННЫХ ПОМЕНЯЛСЯ!!!
# Старые параметры, которые ты знаешь:
#  path_img
#  bottom_text
#  upper_text
#  search_text
#  mode
# Новые параметры
#  upper_color строка цвет
#  bottom_color строка цвет
#  upper_stroke_color строка цвет
#  bottom_stroke_color строка цвет
#  stroke_width целое число
#  giant_text булевое значение
#  В цветовые параметры можно отсылать буковки (F, P, R, M, Y, O, L, G, A, T, B, N, W)
#  или хеш код (#c1121f) хеш обязателен, по нему она определяет, что это не буковка
# TODO:
#  В общем удачи, я тебе дал функцию, ебись с ней как хочешь (Не забудь скачать assets из тг)
#
#  Послесловие я к тебе в функции не лез и ты не лезь пж



class explain_blyat(BaseFilter):
    async def __call__(self, message: Message) -> bool:
        required = 'поясни за '
        return message.text[0:len(required)].lower() == required


# class MemeStates(StatesGroup):
#     demotivator = State()
#     meme = State()
#     book = State()


meme_button: KeyboardButton = KeyboardButton(
    text='Мемас')
demotivator_button: KeyboardButton = KeyboardButton(
    text='Демотиватор')
book_button: KeyboardButton = KeyboardButton(
    text='Чтиво')
settings_button: KeyboardButton = KeyboardButton(
    text='Настройки')
basic_keyboard: ReplyKeyboardMarkup = ReplyKeyboardMarkup(
    keyboard=[[meme_button, demotivator_button], [book_button, settings_button]], resize_keyboard=True)


@dp.message(F.text, explain_blyat())
async def explain_func(message: Message):
    required = 'поясни за '
    txt = message.text[len(required):]

    sent_message = await message.answer('Секунду, братан, шестерёнки работают')
    loading_task = asyncio.create_task(loading_indicator(sent_message.chat.id, sent_message.message_id))
    try:
        response = await get_neuro_comment(txt.replace("\n", " "))
        await message.answer(response, reply_markup=basic_keyboard)
    finally:
        loading_task.cancel()
        await bot.delete_message(chat_id=message.chat.id, message_id=sent_message.message_id)


@dp.message(Command(commands='delete_pictures'), F.from_user.id.in_({972753303}))
async def delete_pictures_in_directory(message: Message):
    try:
        directory = f'{os.path.dirname(__file__)}/pictures'
        files = os.listdir(directory)
        for file in files:
            file_path = os.path.join(directory, file)
            os.remove(file_path)
        await message.answer('Файлы удалены! ✅')
    except Exception as e:
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 634\n{e}')


@dp.message(CommandStart())
async def process_start_command(message: Message):
    await UserDB.add_new_user(message.from_user.id, message.from_user.username)
    await message.answer('Привет! В этом боте ты можешь сгенерировать мем или демотиватор!', reply_markup=basic_keyboard)


@dp.message(Command(commands='meme'))
async def send_meme_lmao(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='in')


@dp.message(Command(commands='help'))
async def help_command(message: Message):
    await message.answer('<b>Помощь калекам</b>\nДля создания реальной ржаки, тебе нужно нажать на кнопочки снизу (Выбрать шаблон)\n'
                         'Далее пишешь: запрос на картинку, текст сверху и текст снизу. Всё с новой строчки!\n\n'
                         '<b>Пример</b>\n'
                         '<blockquote>Камчатка\n'
                         'Сочи\n'
                         'Вы ебанутые?</blockquote>\n\n'
                         'Так же ты можешь прислать фотку и подписать её верхним и нижним текстом\n\n'
                         '<b>Пример</b> (Подпись к фотке)\n'
                         '<blockquote>Сочи\n'
                         'Вы ебанутые?</blockquote>', reply_markup=basic_keyboard)


@dp.message(Command(commands='deme'))
async def create_demo_command(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='de')


@dp.message(Command(commands='book'))
async def create_demo_command(message: Message):
    await send_meme(message, user=await UserDB.get_user(message.from_user.id, message.from_user.username), mode='bo')


@dp.message(F.text == 'Настройки')
async def settings_handler(message: Message):
    settings = await UserDB.get_user(message.from_user.id, message.from_user.username)

    txt = ('<b>Твои текущие настройки</b>\n\n'
           f'Режим: <i>{settings.mode}</i>\n'
           f'Цвет верхнего текста: <i>{settings.upper_color}</i>\n'
           f'Цвет нижнего текста: <i>{settings.bottom_color}</i>\n'
           f'Контур верхнего текста: <i>{settings.upper_stroke_color}</i>\n'
           f'Контур нижнего текста: <i>{settings.bottom_stroke_color}</i>\n'
           f'Регистр текста: <i>{settings.giant_text}</i>\n')
    await message.answer(txt, reply_markup=get_keyboard(settings))


@dp.message(F.text == 'Демотиватор')
async def set_demotivator(message: Message):
    await UserDB.change_mode(message.from_user.id, 'de')
    await message.answer('Режим изменён на <b>демотиватор</b>', reply_markup=basic_keyboard)


@dp.message(F.text == 'Мемас')
async def set_meme(message: Message):
    await UserDB.change_mode(message.from_user.id, 'in')
    await message.answer('Режим изменён на <b>мемас</b>', reply_markup=basic_keyboard)


@dp.message(F.text == 'Чтиво')
async def set_book(message: Message,):
    await UserDB.change_mode(message.from_user.id, 'bo')
    await message.answer('Режим изменён на <b>чтиво</b>', reply_markup=basic_keyboard)


async def send_meme(message: Message, user: UserDB, mode=None):
    try:
        if message.text is None and message.caption is None:
            await message.answer('Ты забыл про надпись')
            return
        meme_txt = (message.text if message.text else message.caption).strip().split('\n')
        meme_txt[0] = meme_txt[0].replace('/', '').replace("\\", '')
        photo_path = None
        if message.photo:
            photo_path = f'{os.path.dirname(__file__)}/pictures/photo{random.randint(1, 10 ** 8)}.jpg'
            await bot.download_file((await bot.get_file(message.photo[-1].file_id)).file_path, photo_path)
            meme_txt = [None] + meme_txt
        try:
            meme_path = await create_meme(photo_path, *meme_txt,
                                          mode=mode if mode else user.mode,
                                          upper_color=user.upper_color,
                                          bottom_color=user.bottom_color,
                                          upper_stroke_color=user.upper_stroke_color,
                                          bottom_stroke_color=user.bottom_stroke_color,
                                          stroke_width=user.stroke_width,
                                          giant_text=user.giant_text)
            await message.answer_photo(photo=FSInputFile(meme_path), reply_markup=basic_keyboard)
            os.remove(meme_path)
        except Exception as e:
            await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
            await bot.send_message(chat_id=972753303, text=f'Произошла ошибка!\n{e}')
    except Exception as e:
        await message.answer('Что-то пошло не так', reply_markup=basic_keyboard)
        await bot.send_message(chat_id=972753303, text=f'Произошла ошибка! Код 234\n{e}')


@dp.message(F.content_type.in_({'text', 'photo'}))
async def general_send_meme(message: Message):
    user = await UserDB.get_user(message.from_user.id, message.from_user.username)
    await send_meme(message, user)


@dp.message()
async def any_message(message: Message):
    await message.answer(text=random.choice(hz_answers), reply_markup=basic_keyboard)


async def main():
    await dp.start_polling(bot)


if __name__ == '__main__':
    print('Режим клоуна включён!')
    asyncio.run(main())
